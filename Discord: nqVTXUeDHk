-- GitanXUI_Pro.lua
-- Polished, full-featured Roblox UI Module suitable for hosting on GitHub.
-- Designed to be required from a LocalScript (client). Original implementation inspired by modern menu libraries.

local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

local GitanXUI = {}
GitanXUI.__version = "pro-1.0.1-fixed-colorpicker"

-- Default theme (tweakable)
GitanXUI.DefaultTheme = {
    WindowBg = Color3.fromRGB(16,18,22),
    TitleBg  = Color3.fromRGB(10,110,220),
    TabsBg   = Color3.fromRGB(26,28,32),
    ContentBg = Color3.fromRGB(12,13,15),
    Accent    = Color3.fromRGB(85,170,255),
    AccentAlt = Color3.fromRGB(165,90,255),
    Primary   = Color3.fromRGB(38,42,50),
    Text      = Color3.fromRGB(245,245,245),
    Muted     = Color3.fromRGB(150,150,160),
    NotificationBg = Color3.fromRGB(10,10,12),
}

-- small utilities
local function safeTween(inst, props, time, style, dir)
    time = time or 0.18
    style = style or Enum.EasingStyle.Quad
    dir = dir or Enum.EasingDirection.Out
    pcall(function()
        local info = TweenInfo.new(time, style, dir)
        local t = TweenService:Create(inst, info, props)
        t:Play()
    end)
end

local function clamp(v, a, b)
    if a and v < a then return a end
    if b and v > b then return b end
    return v
end

local function makeCorner(parent, radius)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, radius or 8)
    c.Parent = parent
    return c
end

local function makeStroke(parent, color, thickness, trans)
    local s = Instance.new("UIStroke")
    s.Color = color or Color3.fromRGB(0,0,0)
    s.Thickness = thickness or 1
    s.Transparency = trans or 0.9
    s.Parent = parent
    return s
end

local function makeGradient(parent, a, b, rot)
    local g = Instance.new("UIGradient")
    g.Color = ColorSequence.new(a, b or a)
    if rot then g.Rotation = rot end
    g.Parent = parent
    return g
end

local function getPlayerGui()
    local pl = Players.LocalPlayer
    if pl then return pl:WaitForChild("PlayerGui") end
    return game:GetService("CoreGui")
end

-- ripple effect
local function ripple(parent, x, y, color)
    pcall(function()
        local r = Instance.new("Frame", parent)
        r.AnchorPoint = Vector2.new(0.5, 0.5)
        r.Position = UDim2.new(0, x, 0, y)
        r.Size = UDim2.fromOffset(10, 10)
        r.BackgroundColor3 = color or Color3.fromRGB(255,255,255)
        r.BackgroundTransparency = 0.7
        r.ZIndex = (parent.ZIndex or 1) + 5
        makeCorner(r, 99)
        safeTween(r, {Size = UDim2.fromScale(8,8), BackgroundTransparency = 1}, 0.45)
        delay(0.55, function() if r and r.Parent then r:Destroy() end end)
    end)
end

-- notifications queue
local function enqueueNotification(win, title, text, duration)
    duration = duration or 3
    win._notifQueue = win._notifQueue or {}
    table.insert(win._notifQueue, {title = title, text = text, duration = duration})
    if win._notifRunning then return end
    win._notifRunning = true
    spawn(function()
        while #win._notifQueue > 0 do
            local n = table.remove(win._notifQueue, 1)
            local notif = Instance.new("Frame", win.ScreenGui)
            notif.Size = UDim2.fromOffset(380, 72)
            notif.Position = UDim2.new(0.5, -190, 0.12, 0)
            notif.AnchorPoint = Vector2.new(0.5, 0)
            notif.BackgroundColor3 = win.Theme.NotificationBg
            notif.ZIndex = 3000
            makeCorner(notif, 10)
            makeStroke(notif, Color3.fromRGB(0,0,0), 1, 0.9)

            local t = Instance.new("TextLabel", notif)
            t.Size = UDim2.new(1, -24, 0, 20)
            t.Position = UDim2.new(0, 12, 0, 6)
            t.BackgroundTransparency = 1
            t.Font = Enum.Font.GothamBold
            t.TextSize = 14
            t.TextColor3 = win.Theme.Text
            t.Text = n.title or ""
            t.TextXAlignment = Enum.TextXAlignment.Left

            local d = Instance.new("TextLabel", notif)
            d.Size = UDim2.new(1, -24, 0, 36)
            d.Position = UDim2.new(0, 12, 0, 26)
            d.BackgroundTransparency = 1
            d.Font = Enum.Font.Gotham
            d.TextSize = 13
            d.TextColor3 = win.Theme.Muted
            d.Text = n.text or ""
            d.TextXAlignment = Enum.TextXAlignment.Left

            safeTween(notif, {Position = UDim2.new(0.5, -190, 0.14, 0), BackgroundTransparency = 0}, 0.18)
            wait(n.duration)
            safeTween(notif, {Position = UDim2.new(0.5, -190, 0.10, 0)}, 0.16)
            wait(0.25)
            notif:Destroy()
        end
        win._notifRunning = false
    end)
end

-- create ScreenGui
local function CreateScreenGui(name)
    local pg = getPlayerGui()
    local sg = Instance.new("ScreenGui")
    sg.Name = name or ("GitanXUI_" .. tostring(math.random(1000,9999)))
    sg.IgnoreGuiInset = true
    sg.ResetOnSpawn = false
    sg.Parent = pg
    return sg
end

-- Main: CreateWindow
function GitanXUI.CreateWindow(opts)
    opts = opts or {}
    local width = (opts.Size and opts.Size.X) or 820
    local height = (opts.Size and opts.Size.Y) or 520

    local sg = CreateScreenGui(opts.Name or "GitanXUI")
    local frame = Instance.new("Frame", sg)
    frame.Name = "GitanX_Window"
    frame.Size = UDim2.fromOffset(width, height)
    frame.Position = UDim2.new(0.5, -width/2, 0.5, -height/2)
    frame.AnchorPoint = Vector2.new(0.5, 0.5)
    frame.BackgroundColor3 = (opts.Theme and opts.Theme.WindowBg) or GitanXUI.DefaultTheme.WindowBg
    frame.ZIndex = 50
    makeCorner(frame, 16)
    makeStroke(frame, Color3.fromRGB(0,0,0), 1, 0.9)

    -- top accent
    local accent = Instance.new("Frame", frame)
    accent.Size = UDim2.new(1, 0, 0, 6)
    accent.Position = UDim2.new(0, 0, 0, 0)
    accent.BackgroundColor3 = (opts.Theme and opts.Theme.Accent) or GitanXUI.DefaultTheme.Accent
    accent.BackgroundTransparency = 0.78
    makeCorner(accent, 12)

    -- Title bar
    local titleBar = Instance.new("Frame", frame)
    titleBar.Size = UDim2.new(1, 0, 0, 56)
    titleBar.Position = UDim2.new(0, 0, 0, 6)
    titleBar.BackgroundColor3 = (opts.Theme and opts.Theme.TitleBg) or GitanXUI.DefaultTheme.TitleBg
    makeCorner(titleBar, 12)
    makeStroke(titleBar, Color3.fromRGB(0,0,0), 1, 0.9)

    local titleLabel = Instance.new("TextLabel", titleBar)
    titleLabel.Size = UDim2.new(1, -220, 1, 0)
    titleLabel.Position = UDim2.new(0, 16, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 18
    titleLabel.Text = opts.Title or "GitanX Pro"
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.TextColor3 = (opts.Theme and opts.Theme.Text) or GitanXUI.DefaultTheme.Text

    local subtitle = Instance.new("TextLabel", titleBar)
    subtitle.Size = UDim2.new(0, 220, 0, 18)
    subtitle.Position = UDim2.new(0, 16, 1, -20)
    subtitle.BackgroundTransparency = 1
    subtitle.Font = Enum.Font.Gotham
    subtitle.TextSize = 12
    subtitle.Text = opts.Subtitle or ""
    subtitle.TextColor3 = (opts.Theme and opts.Theme.Muted) or GitanXUI.DefaultTheme.Muted

    -- control buttons
    local closeBtn = Instance.new("TextButton", titleBar)
    closeBtn.Size = UDim2.fromOffset(36, 28)
    closeBtn.Position = UDim2.new(1, -48, 0, 14)
    closeBtn.Text = "‚úï"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextColor3 = Color3.fromRGB(255,255,255)
    closeBtn.BackgroundColor3 = Color3.fromRGB(180,70,70)
    makeCorner(closeBtn, 8)
    makeStroke(closeBtn, Color3.fromRGB(0,0,0), 1, 0.9)

    local minBtn = Instance.new("TextButton", titleBar)
    minBtn.Size = UDim2.fromOffset(36, 28)
    minBtn.Position = UDim2.new(1, -92, 0, 14)
    minBtn.Text = "‚Äî"
    minBtn.Font = Enum.Font.GothamBold
    minBtn.TextColor3 = Color3.fromRGB(255,255,255)
    minBtn.BackgroundColor3 = Color3.fromRGB(110,110,110)
    makeCorner(minBtn, 8)
    makeStroke(minBtn, Color3.fromRGB(0,0,0), 1, 0.9)

    -- left tabs + content panel
    local tabsPanel = Instance.new("Frame", frame)
    tabsPanel.Size = UDim2.fromOffset(180, height - 108)
    tabsPanel.Position = UDim2.new(0, 12, 0, 68)
    tabsPanel.BackgroundColor3 = (opts.Theme and opts.Theme.TabsBg) or GitanXUI.DefaultTheme.TabsBg
    makeCorner(tabsPanel, 12)
    makeStroke(tabsPanel, Color3.fromRGB(0,0,0), 1, 0.9)

    local contentPanel = Instance.new("Frame", frame)
    contentPanel.Size = UDim2.new(1, -212, 1, -108)
    contentPanel.Position = UDim2.new(0, 200, 0, 68)
    contentPanel.BackgroundColor3 = (opts.Theme and opts.Theme.ContentBg) or GitanXUI.DefaultTheme.ContentBg
    makeCorner(contentPanel, 12)
    makeStroke(contentPanel, Color3.fromRGB(0,0,0), 1, 0.9)

    local tabsLayout = Instance.new("UIListLayout", tabsPanel)
    tabsLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabsLayout.Padding = UDim.new(0, 10)

    local contentLayout = Instance.new("UIListLayout", contentPanel)
    contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
    contentLayout.Padding = UDim.new(0, 14)

    local window = {
        ScreenGui = sg,
        Frame = frame,
        TitleBar = titleBar,
        Title = titleLabel,
        Subtitle = subtitle,
        TabsPanel = tabsPanel,
        ContentPanel = contentPanel,
        Theme = opts.Theme or GitanXUI.DefaultTheme,
        Tabs = {},
        _notifQueue = {},
    }

    -- drag logic
    do
        local dragging = false
        local dragStart, startPos
        titleBar.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                dragStart = input.Position
                startPos = frame.Position
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then dragging = false end
                end)
            end
        end)
        UserInputService.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local delta = input.Position - dragStart
                frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
        end)
    end

    -- minimize/close
    do
        local minimized = false
        minBtn.MouseButton1Click:Connect(function()
            minimized = not minimized
            if minimized then
                safeTween(contentPanel, {Size = UDim2.new(1, -212, 0, 0)}, 0.16)
                for _,c in ipairs(contentPanel:GetChildren()) do if c:IsA("GuiObject") then c.Visible = false end end
            else
                for _,c in ipairs(contentPanel:GetChildren()) do if c:IsA("GuiObject") then c.Visible = true end end
                safeTween(contentPanel, {Size = UDim2.new(1, -212, 1, -108)}, 0.16)
            end
        end)
        closeBtn.MouseButton1Click:Connect(function()
            if window.ScreenGui then window.ScreenGui:Destroy() end
        end)
    end

    -- CreateTab
    function window:CreateTab(name, icon)
        local idx = #self.Tabs + 1
        local btn = Instance.new("TextButton", self.TabsPanel)
        btn.Name = "TabBtn_" .. tostring(name)
        btn.Size = UDim2.new(1, -20, 0, 46)
        btn.Position = UDim2.new(0, 10, 0, (idx-1) * 56 + 10)
        btn.BackgroundColor3 = Color3.fromRGB(36,36,40)
        btn.Text = (icon and (icon .. "  ") or "") .. tostring(name)
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 14
        btn.TextColor3 = self.Theme.Text
        btn.TextXAlignment = Enum.TextXAlignment.Left
        makeCorner(btn, 10)
        makeStroke(btn, Color3.fromRGB(0,0,0), 1, 0.9)

        local page = Instance.new("Frame", self.ContentPanel)
        page.Name = "Page_" .. tostring(name)
        page.Size = UDim2.new(1, -24, 0, 0)
        page.BackgroundTransparency = 1
        page.Visible = false
        page.LayoutOrder = idx

        local pageLayout = Instance.new("UIListLayout", page)
        pageLayout.SortOrder = Enum.SortOrder.LayoutOrder
        pageLayout.Padding = UDim.new(0, 10)

        local tab = {Name = name, Button = btn, Page = page}
        table.insert(self.Tabs, tab)

        btn.MouseEnter:Connect(function() safeTween(btn, {BackgroundColor3 = Color3.fromRGB(48,48,54)}, 0.12) end)
        btn.MouseLeave:Connect(function() if not page.Visible then safeTween(btn, {BackgroundColor3 = Color3.fromRGB(36,36,40)}, 0.12) end end)
        btn.MouseButton1Click:Connect(function()
            for _, t in ipairs(self.Tabs) do
                t.Page.Visible = false
                t.Button.BackgroundColor3 = Color3.fromRGB(36,36,40)
            end
            page.Visible = true
            btn.BackgroundColor3 = self.Theme.Accent
        end)

        if #self.Tabs == 1 then
            btn.BackgroundColor3 = self.Theme.Accent
            page.Visible = true
        end

        -- CreateSection on page
        function tab:CreateSection(title)
            local sec = Instance.new("Frame", self.Page)
            sec.BackgroundColor3 = Color3.fromRGB(24,24,26)
            sec.Size = UDim2.new(1, 0, 0, 120)
            makeCorner(sec, 12)
            makeStroke(sec, Color3.fromRGB(0,0,0), 1, 0.9)
            sec.LayoutOrder = #self.Page:GetChildren()

            local pad = Instance.new("UIPadding", sec)
            pad.PaddingLeft = UDim.new(0, 12)
            pad.PaddingTop = UDim.new(0, 12)

            local titleLbl = Instance.new("TextLabel", sec)
            titleLbl.Size = UDim2.new(1, -20, 0, 20)
            titleLbl.Position = UDim2.new(0, 6, 0, 0)
            titleLbl.BackgroundTransparency = 1
            titleLbl.Font = Enum.Font.GothamBold
            titleLbl.TextSize = 14
            titleLbl.TextColor3 = window.Theme.Text
            titleLbl.Text = title or ""

            local inner = Instance.new("Frame", sec)
            inner.Position = UDim2.new(0, 0, 0, 28)
            inner.Size = UDim2.new(1, -20, 1, -36)
            inner.BackgroundTransparency = 1

            local list = Instance.new("UIListLayout", inner)
            list.SortOrder = Enum.SortOrder.LayoutOrder
            list.Padding = UDim.new(0, 10)

            local section = {}

            -- Button
            function section:CreateButton(opts)
                local text = (type(opts) == "table" and opts.Name) or tostring(opts)
                local cb = (type(opts) == "table" and opts.Callback) or (function() end)
                local b = Instance.new("TextButton", inner)
                b.Size = UDim2.new(1, 0, 0, 40)
                b.BackgroundColor3 = window.Theme.Primary
                b.Text = text or "Button"
                b.Font = Enum.Font.Gotham
                b.TextSize = 14
                b.TextColor3 = window.Theme.Text
                makeCorner(b, 10); makeStroke(b, Color3.fromRGB(0,0,0), 1, 0.9)
                b.MouseEnter:Connect(function() safeTween(b, {BackgroundColor3 = Color3.fromRGB(64,64,72)}, 0.12) end)
                b.MouseLeave:Connect(function() safeTween(b, {BackgroundColor3 = window.Theme.Primary}, 0.12) end)
                b.MouseButton1Click:Connect(function(x,y)
                    pcall(function() ripple(b, x - b.AbsolutePosition.X, y - b.AbsolutePosition.Y, Color3.fromRGB(255,255,255)) end)
                    pcall(cb)
                end)
                return b
            end

            -- Toggle
            function section:CreateToggle(opts)
                opts = opts or {}
                local name = opts.Name or "Toggle"
                local default = opts.Default or false
                local cb = opts.Callback or function() end

                local container = Instance.new("Frame", inner)
                container.Size = UDim2.new(1, 0, 0, 40)
                container.BackgroundTransparency = 1

                local label = Instance.new("TextLabel", container)
                label.Size = UDim2.new(1, -110, 1, 0)
                label.Position = UDim2.new(0, 8, 0, 0)
                label.BackgroundTransparency = 1
                label.Font = Enum.Font.Gotham
                label.TextSize = 14
                label.TextColor3 = window.Theme.Text
                label.Text = name
                label.TextXAlignment = Enum.TextXAlignment.Left

                local box = Instance.new("Frame", container)
                box.Size = UDim2.fromOffset(64, 34)
                box.Position = UDim2.new(1, -78, 0, 3)
                box.BackgroundColor3 = default and window.Theme.Accent or Color3.fromRGB(70,70,74)
                makeCorner(box, 18); makeStroke(box, Color3.fromRGB(0,0,0), 1, 0.9)

                local knob = Instance.new("Frame", box)
                knob.Size = UDim2.fromOffset(26, 26)
                knob.Position = default and UDim2.new(1, -30, 0, 4) or UDim2.new(0, 4, 0, 4)
                knob.BackgroundColor3 = Color3.fromRGB(250,250,250)
                makeCorner(knob, 14); makeStroke(knob, Color3.fromRGB(0,0,0), 1, 0.9)

                local btn = Instance.new("TextButton", box)
                btn.Size = UDim2.new(1,0,1,0)
                btn.BackgroundTransparency = 1
                btn.Text = ""
                btn.AutoButtonColor = false

                local state = default
                local function apply(s, anim)
                    state = s and true or false
                    if state then
                        if anim then safeTween(knob, {Position = UDim2.new(1, -30, 0, 4)}, 0.14); safeTween(box, {BackgroundColor3 = window.Theme.Accent}, 0.14)
                        else knob.Position = UDim2.new(1, -30, 0, 4); box.BackgroundColor3 = window.Theme.Accent end
                    else
                        if anim then safeTween(knob, {Position = UDim2.new(0, 4, 0, 4)}, 0.14); safeTween(box, {BackgroundColor3 = Color3.fromRGB(70,70,74)}, 0.14)
                        else knob.Position = UDim2.new(0, 4, 0, 4); box.BackgroundColor3 = Color3.fromRGB(70,70,74) end
                    end
                end

                btn.MouseButton1Click:Connect(function()
                    apply(not state, true)
                    pcall(cb, state)
                end)

                return {
                    Button = btn,
                    GetState = function() return state end,
                    SetState = function(v) apply(v, false); pcall(cb, state) end
                }
            end

            -- Slider (full featured)
            function section:CreateSlider(opts)
                opts = opts or {}
                local labelText = opts.Name or "Slider"
                local min = (opts.Min ~= nil) and opts.Min or 0
                local max = (opts.Max ~= nil) and opts.Max or 1
                local initial = (opts.Default ~= nil) and opts.Default or min
                local cb = opts.Callback or function() end
                local step = opts.Step -- optional
                local reversed = opts.Reversed and true or false
                local decimals = opts.Decimals -- optional

                if max == min then max = min + 1 end

                if step == nil then
                    if math.abs(min - math.floor(min)) < 1e-6 and math.abs(max - math.floor(max)) < 1e-6 then
                        step = 1
                    else
                        step = 0
                    end
                end
                if step == 0 then step = nil end

                local cont = Instance.new("Frame", inner)
                cont.Size = UDim2.new(1, 0, 0, 60)
                cont.BackgroundTransparency = 1

                local lbl = Instance.new("TextLabel", cont)
                lbl.Size = UDim2.new(1, -120, 0, 20)
                lbl.Position = UDim2.new(0, 8, 0, 0)
                lbl.BackgroundTransparency = 1
                lbl.Font = Enum.Font.Gotham
                lbl.TextSize = 14
                lbl.TextColor3 = window.Theme.Text
                lbl.Text = labelText
                lbl.TextXAlignment = Enum.TextXAlignment.Left

                local valLbl = Instance.new("TextLabel", cont)
                valLbl.Size = UDim2.new(0, 80, 0, 20)
                valLbl.Position = UDim2.new(1, -92, 0, 0)
                valLbl.BackgroundTransparency = 1
                valLbl.Font = Enum.Font.Gotham
                valLbl.TextSize = 13
                valLbl.TextColor3 = window.Theme.Muted
                valLbl.Text = tostring(initial)

                local floatLbl = Instance.new("TextLabel", cont)
                floatLbl.Size = UDim2.new(0, 60, 0, 20)
                floatLbl.AnchorPoint = Vector2.new(0.5, 1)
                floatLbl.Position = UDim2.new(0, 0, 0, 22)
                floatLbl.BackgroundTransparency = 0.45
                floatLbl.BackgroundColor3 = Color3.fromRGB(0,0,0)
                floatLbl.Font = Enum.Font.GothamBold
                floatLbl.TextSize = 12
                floatLbl.TextColor3 = window.Theme.Text
                makeCorner(floatLbl, 6)
                floatLbl.Visible = false

                local bar = Instance.new("Frame", cont)
                bar.Size = UDim2.new(1, -24, 0, 12)
                bar.Position = UDim2.new(0, 12, 0, 36)
                bar.BackgroundColor3 = Color3.fromRGB(42,42,46)
                makeCorner(bar, 8)
                makeStroke(bar, Color3.fromRGB(0,0,0), 1, 0.9)

                local relInit = clamp((initial - min) / (max - min), 0, 1)
                local rawInit = reversed and (1 - relInit) or relInit

                local fill = Instance.new("Frame", bar)
                fill.Size = UDim2.new(rawInit, 0, 1, 0)
                fill.BackgroundColor3 = window.Theme.Accent
                makeCorner(fill, 8)

                local handle = Instance.new("Frame", bar)
                handle.Size = UDim2.fromOffset(16, 16)
                handle.AnchorPoint = Vector2.new(0.5, 0.5)
                handle.Position = UDim2.new(rawInit, 0, 0.5, 0)
                handle.BackgroundColor3 = Color3.fromRGB(245,245,245)
                makeCorner(handle, 10)
                makeStroke(handle, Color3.fromRGB(0,0,0), 1, 0.9)

                local dragging = false

                local function quantize(raw)
                    if step and step > 0 then
                        local n = math.floor((raw - min)/step + 0.5)
                        return clamp(min + n * step, min, max)
                    end
                    return raw
                end

                local function fmt(v)
                    if decimals ~= nil then
                        return string.format("%." .. tostring(decimals) .. "f", v)
                    end
                    if step and step > 0 and math.abs(step - math.floor(step)) < 1e-6 then
                        return tostring(math.floor(v + 0.5))
                    end
                    if math.abs(v - math.floor(v)) < 1e-6 then
                        return tostring(math.floor(v))
                    end
                    return string.format("%.2f", v)
                end

                local function updateFloat(visualRel, val)
                    floatLbl.Visible = true
                    floatLbl.Position = UDim2.new(visualRel, 0, 0, 22)
                    floatLbl.Text = fmt(val)
                end

                local function updateFromX(x)
                    local absX = bar.AbsolutePosition.X
                    local absW = bar.AbsoluteSize.X
                    if absW <= 0 then return end
                    local relRaw = clamp((x - absX) / absW, 0, 1)
                    local relMapped = reversed and (1 - relRaw) or relRaw
                    local rawVal = min + relMapped * (max - min)
                    local q = quantize(rawVal)
                    local relAfter = (q - min) / (max - min)
                    local visualRel = reversed and (1 - relAfter) or relAfter

                    fill.Size = UDim2.new(visualRel, 0, 1, 0)
                    handle.Position = UDim2.new(visualRel, 0, 0.5, 0)
                    valLbl.Text = fmt(q)
                    updateFloat(visualRel, q)
                    pcall(cb, q)
                end

                local absConn
                absConn = bar:GetPropertyChangedSignal("AbsoluteSize"):Connect(function()
                    if bar.AbsoluteSize.X > 0 then
                        local relMapped = clamp((initial - min)/(max - min), 0, 1)
                        local visual = reversed and (1 - relMapped) or relMapped
                        fill.Size = UDim2.new(visual, 0, 1, 0)
                        handle.Position = UDim2.new(visual, 0, 0.5, 0)
                        valLbl.Text = fmt(quantize(initial))
                        floatLbl.Text = fmt(quantize(initial))
                        floatLbl.Visible = false
                        if absConn then absConn:Disconnect(); absConn = nil end
                    end
                end)

                bar.InputBegan:Connect(function(inp)
                    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                        dragging = true
                        updateFromX(inp.Position.X)
                    end
                end)
                bar.InputChanged:Connect(function(inp)
                    if dragging and inp.UserInputType == Enum.UserInputType.MouseMovement then updateFromX(inp.Position.X) end
                end)
                bar.InputEnded:Connect(function(inp)
                    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                        dragging = false
                        delay(0.12, function() floatLbl.Visible = false end)
                    end
                end)

                handle.InputBegan:Connect(function(inp)
                    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then dragging = true end
                end)
                handle.InputChanged:Connect(function(inp)
                    if dragging and inp.UserInputType == Enum.UserInputType.MouseMovement then updateFromX(inp.Position.X) end
                end)
                handle.InputEnded:Connect(function(inp)
                    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                        dragging = false
                        delay(0.12, function() floatLbl.Visible = false end)
                    end
                end)

                local function SetValue(v)
                    v = tonumber(v) or min
                    v = clamp(v, min, max)
                    v = quantize(v)
                    local relMapped = (v - min) / (max - min)
                    local visual = reversed and (1 - relMapped) or relMapped
                    fill.Size = UDim2.new(visual, 0, 1, 0)
                    handle.Position = UDim2.new(visual, 0, 0.5, 0)
                    valLbl.Text = fmt(v)
                    pcall(cb, v)
                end

                local function GetValue()
                    return tonumber(valLbl.Text) or min
                end

                SetValue(initial)

                return {Container = cont, GetValue = GetValue, SetValue = SetValue}
            end

            -- Dropdown
            function section:CreateDropdown(opts)
                opts = opts or {}
                local lbl = opts.Name or "Dropdown"
                local items = opts.Items or {}
                local cb = opts.Callback or function() end
                local container = Instance.new("Frame", inner); container.Size = UDim2.new(1,0,0,36); container.BackgroundTransparency = 1
                local label = Instance.new("TextLabel", container); label.Size = UDim2.new(1, -160, 1, 0); label.Position = UDim2.new(0,8,0,0)
                label.BackgroundTransparency = 1; label.Text = lbl; label.Font = Enum.Font.Gotham; label.TextColor3 = window.Theme.Text; label.TextSize = 13
                local btn = Instance.new("TextButton", container); btn.Size = UDim2.new(0,140,0,28); btn.Position = UDim2.new(1,-152,0,4)
                btn.BackgroundColor3 = Color3.fromRGB(48,48,52); btn.Text = items[1] or "Choose"; btn.Font = Enum.Font.Gotham; btn.TextColor3 = window.Theme.Text
                makeCorner(btn, 6); makeStroke(btn, Color3.fromRGB(0,0,0), 1, 0.9)
                local list = Instance.new("Frame", container); list.Size = UDim2.new(0,160,0, math.min(6, #items) * 30); list.Position = UDim2.new(1,-152,1,6)
                list.BackgroundColor3 = Color3.fromRGB(36,36,40); list.Visible = false; makeCorner(list, 8); makeStroke(list, Color3.fromRGB(0,0,0),1,0.9)
                for i,it in ipairs(items) do
                    local itb = Instance.new("TextButton", list)
                    itb.Size = UDim2.new(1, -8, 0, 28); itb.Position = UDim2.new(0,4,0,(i-1)*30)
                    itb.BackgroundTransparency = 1; itb.Text = it; itb.Font = Enum.Font.Gotham; itb.TextColor3 = window.Theme.Text; itb.TextSize = 13
                    itb.TextXAlignment = Enum.TextXAlignment.Left
                    itb.MouseButton1Click:Connect(function() btn.Text = it; list.Visible = false; pcall(cb, it) end)
                end
                btn.MouseButton1Click:Connect(function() if #items == 0 then return end list.Visible = not list.Visible end)
                return {Button = btn, Get = function() return btn.Text end}
            end

            function section:CreateTextbox(opts)
                opts = opts or {}
                local placeholder = opts.Placeholder or ""
                local cb = opts.Callback
                local box = Instance.new("TextBox", inner)
                box.Size = UDim2.new(1, 0, 0, 28); box.BackgroundColor3 = Color3.fromRGB(36,36,40); box.TextColor3 = window.Theme.Text
                box.PlaceholderText = placeholder; box.Font = Enum.Font.Gotham; box.TextSize = 14
                makeCorner(box, 8); makeStroke(box, Color3.fromRGB(0,0,0), 1, 0.9)
                box.ClearTextOnFocus = false
                box.FocusLost:Connect(function(enter) if enter and cb then pcall(cb, box.Text) end end)
                return {Box = box, Get = function() return box.Text end}
            end

            function section:CreateKeybind(opts)
                opts = opts or {}
                local label = opts.Name or "Keybind"; local def = opts.Default or "None"; local cb = opts.Callback or function() end
                local container = Instance.new("Frame", inner); container.Size = UDim2.new(1,0,0,36); container.BackgroundTransparency = 1
                local lbl = Instance.new("TextLabel", container); lbl.Size = UDim2.new(1, -180, 1, 0); lbl.Position = UDim2.new(0,8,0,0)
                lbl.BackgroundTransparency = 1; lbl.Text = label; lbl.Font = Enum.Font.Gotham; lbl.TextColor3 = window.Theme.Text; lbl.TextSize = 13
                local btn = Instance.new("TextButton", container); btn.Size = UDim2.new(0,160,0,28); btn.Position = UDim2.new(1,-172,0,4)
                btn.BackgroundColor3 = Color3.fromRGB(46,46,50); btn.Text = tostring(def); btn.Font = Enum.Font.Gotham; btn.TextColor3 = window.Theme.Text
                makeCorner(btn, 6); makeStroke(btn, Color3.fromRGB(0,0,0), 1, 0.9)
                local capturing = false; local conn
                btn.MouseButton1Click:Connect(function()
                    btn.Text = "Press..."; capturing = true
                    conn = UserInputService.InputBegan:Connect(function(input, gp)
                        if gp then return end
                        if capturing and input.UserInputType == Enum.UserInputType.Keyboard then
                            local k = input.KeyCode.Name; btn.Text = k; capturing = false; pcall(cb, k)
                            if conn then conn:Disconnect(); conn = nil end
                        end
                    end)
                end)
                return {Button = btn, Get = function() return btn.Text end}
            end

            -- CreateColorPicker (fixed: uses local labels instead of attaching fields to Instances)
            function section:CreateColorPicker(opts)
                opts = opts or {}
                local default = opts.Default or {80,160,255}
                local cb = opts.Callback or function() end

                local container = Instance.new("Frame", inner)
                container.Size = UDim2.new(1,0,0,96)
                container.BackgroundTransparency = 1

                local lbl = Instance.new("TextLabel", container)
                lbl.Size = UDim2.new(1, -16, 0, 18)
                lbl.Position = UDim2.new(0,8,0,0)
                lbl.BackgroundTransparency = 1
                lbl.Font = Enum.Font.Gotham
                lbl.Text = opts.Name or "Color"
                lbl.TextColor3 = window.Theme.Text
                lbl.TextSize = 13
                lbl.TextXAlignment = Enum.TextXAlignment.Left

                local preview = Instance.new("Frame", container)
                preview.Size = UDim2.fromOffset(56,56)
                preview.Position = UDim2.new(1,-72,0,22)
                preview.BackgroundColor3 = Color3.fromRGB(default[1], default[2], default[3])
                makeCorner(preview,10)
                makeStroke(preview, Color3.fromRGB(0,0,0),1,0.9)

                local function smallSlider(y, labelTxt, init)
                    local scont = Instance.new("Frame", container)
                    scont.Size = UDim2.new(1, -96, 0, 22)
                    scont.Position = UDim2.new(0,8,0,y)
                    scont.BackgroundTransparency = 1

                    local name = Instance.new("TextLabel", scont)
                    name.Size = UDim2.new(0,28,1,0)
                    name.BackgroundTransparency = 1
                    name.Text = labelTxt
                    name.Font = Enum.Font.GothamBold
                    name.TextSize = 12
                    name.TextColor3 = window.Theme.Text

                    local bar = Instance.new("Frame", scont)
                    bar.Size = UDim2.new(1, -60, 1, 0)
                    bar.Position = UDim2.new(0,36,0,0)
                    bar.BackgroundColor3 = Color3.fromRGB(36,36,40)
                    makeCorner(bar,6); makeStroke(bar, Color3.fromRGB(0,0,0),1,0.9)

                    local fill = Instance.new("Frame", bar)
                    local iv = clamp((init or 128), 0, 255)
                    fill.Size = UDim2.new(iv/255, 0, 1, 0)
                    fill.BackgroundColor3 = GitanXUI.DefaultTheme.Accent
                    makeCorner(fill,6)

                    local valLbl = Instance.new("TextLabel", scont)
                    valLbl.Size = UDim2.new(0,28,1,0)
                    valLbl.Position = UDim2.new(1,-28,0,0)
                    valLbl.BackgroundTransparency = 1
                    valLbl.Text = tostring(math.floor(iv))
                    valLbl.Font = Enum.Font.Gotham
                    valLbl.TextSize = 12
                    valLbl.TextColor3 = window.Theme.Muted

                    local dragging = false
                    local function updateFromX(x)
                        if bar.AbsoluteSize.X <= 0 then return end
                        local rel = clamp((x - bar.AbsolutePosition.X) / bar.AbsoluteSize.X, 0, 1)
                        fill.Size = UDim2.new(rel, 0, 1, 0)
                        valLbl.Text = tostring(math.floor(rel * 255))
                    end
                    bar.InputBegan:Connect(function(inp) if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then dragging = true; updateFromX(inp.Position.X) end end)
                    bar.InputChanged:Connect(function(inp) if dragging and inp.UserInputType == Enum.UserInputType.MouseMovement then updateFromX(inp.Position.X) end end)
                    bar.InputEnded:Connect(function(inp) if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then dragging = false end end)

                    return fill, valLbl
                end

                local rfill, rlbl = smallSlider(22, "R", default[1] or 80)
                local gfill, glbl = smallSlider(44, "G", default[2] or 160)
                local bfill, blbl = smallSlider(66, "B", default[3] or 255)

                -- Use local variables (closures) instead of setting container._r etc.
                local rLabel, gLabel, bLabel = rlbl, glbl, blbl

                spawn(function()
                    while container.Parent do
                        local r = tonumber(rLabel.Text) or 0
                        local g = tonumber(gLabel.Text) or 0
                        local b = tonumber(bLabel.Text) or 0
                        local c = Color3.fromRGB(clamp(r,0,255), clamp(g,0,255), clamp(b,0,255))
                        if preview and preview.Parent then
                            preview.BackgroundColor3 = c
                        end
                        pcall(cb, c)
                        wait(0.12)
                    end
                end)

                return {
                    Container = container,
                    Get = function()
                        local r = tonumber(rLabel.Text) or 0
                        local g = tonumber(gLabel.Text) or 0
                        local b = tonumber(bLabel.Text) or 0
                        return Color3.fromRGB(clamp(r,0,255), clamp(g,0,255), clamp(b,0,255))
                    end,
                    Set = function(col)
                        if typeof(col) == "Color3" then
                            local rr = math.floor(col.R*255+0.5)
                            local gg = math.floor(col.G*255+0.5)
                            local bb = math.floor(col.B*255+0.5)
                            if rLabel then rLabel.Text = tostring(clamp(rr,0,255)) end
                            if gLabel then gLabel.Text = tostring(clamp(gg,0,255)) end
                            if bLabel then bLabel.Text = tostring(clamp(bb,0,255)) end
                        elseif type(col) == "table" and #col >= 3 then
                            if rLabel then rLabel.Text = tostring(clamp(math.floor(col[1]),0,255)) end
                            if gLabel then gLabel.Text = tostring(clamp(math.floor(col[2]),0,255)) end
                            if bLabel then bLabel.Text = tostring(clamp(math.floor(col[3]),0,255)) end
                        end
                    end
                }
            end

            return section
        end

        return tab
    end

    -- window methods
    function window:SetVisible(v) if self.ScreenGui then self.ScreenGui.Enabled = v end end
    function window:Close() if self.ScreenGui then self.ScreenGui:Destroy() end end
    function window:Notify(t1, t2, d) enqueueNotification(self, t1, t2, d) end

    function window:SaveConfig(name, tbl)
        local ok, json = pcall(function() return HttpService:JSONEncode(tbl) end)
        if ok then
            local pl = Players.LocalPlayer
            if pl then pl:SetAttribute("GitanXUI_Config_" .. tostring(name), json) end
        end
    end
    function window:LoadConfig(name)
        local pl = Players.LocalPlayer
        if pl then
            local attr = pl:GetAttribute("GitanXUI_Config_" .. tostring(name))
            if attr and type(attr) == "string" then
                local ok, tbl = pcall(function() return HttpService:JSONDecode(attr) end)
                if ok then return tbl end
            end
        end
        return nil
    end

    window.CreateTab = window.CreateTab
    return window
end

-- Demo builder for quick preview
function GitanXUI.Demo()
    local w = GitanXUI.CreateWindow({Name="GitanX_Pro_Demo", Title="GitanX Pro", Subtitle="Beautiful & powerful", Size = Vector2.new(960, 620)})
    local home = w:CreateTab("Home", "üè†")
    local s1 = home:CreateSection("Welcome")
    s1:CreateButton({Name="Say Hello", Callback=function() w:Notify("Hello", "Welcome to GitanX Pro", 2) end})
    s1:CreateToggle({Name="Demo Toggle", Default=false, Callback=function(v) w:Notify("Toggle", tostring(v), 1.2) end})
    s1:CreateSlider({Name="Demo Slider", Min=1, Max=8, Default=3, Step=1, Callback=function(v) print("demo slider", v) end})
    s1:CreateSlider({Name="Smooth Slider", Min=0, Max=1, Default=0.45, Decimals=2, Callback=function(v) print("smooth", v) end})
    local vis = w:CreateTab("Visuals", "üé®")
    local sv = vis:CreateSection("Theme")
    sv:CreateDropdown({Name="Theme Preset", Items={"Default","Ocean","Violet"}, Callback=function(choice)
        if choice == "Ocean" then
            w.Theme = {
                WindowBg = Color3.fromRGB(10,12,16),
                TitleBg  = Color3.fromRGB(8,120,200),
                TabsBg   = Color3.fromRGB(20,22,26),
                ContentBg = Color3.fromRGB(8,10,12),
                Accent    = Color3.fromRGB(70,180,240),
                Primary   = Color3.fromRGB(32,36,44),
                Text      = Color3.fromRGB(240,240,240),
                Muted     = Color3.fromRGB(150,150,160),
                NotificationBg = Color3.fromRGB(8,8,10),
            }
        elseif choice == "Violet" then
            w.Theme = {
                WindowBg = Color3.fromRGB(14,12,18),
                TitleBg  = Color3.fromRGB(90,40,180),
                TabsBg   = Color3.fromRGB(22,20,28),
                ContentBg = Color3.fromRGB(10,10,12),
                Accent    = Color3.fromRGB(170,90,255),
                Primary   = Color3.fromRGB(34,32,40),
                Text      = Color3.fromRGB(245,245,245),
                Muted     = Color3.fromRGB(150,150,160),
                NotificationBg = Color3.fromRGB(8,8,10),
            }
        else
            w.Theme = GitanXUI.DefaultTheme
        end
        -- apply
        if w.Frame then w.Frame.BackgroundColor3 = w.Theme.WindowBg end
        if w.TitleBar then w.TitleBar.BackgroundColor3 = w.Theme.TitleBg end
        if w.TabsPanel then w.TabsPanel.BackgroundColor3 = w.Theme.TabsBg end
        if w.ContentPanel then w.ContentPanel.BackgroundColor3 = w.Theme.ContentBg end
        w:Notify("Theme", "Applied: " .. tostring(choice), 1.2)
    end})
    return w
end

return GitanXUI
